#!/usr/bin/env python3
import json

import os
import sys
import urllib.request
import zipfile
import io

__author__ = 'kristoffer'

download_dir = "/download"


def _read_versions(path, target_versions):
    if len(target_versions) > 0:
        target_versions = '-' + target_versions
    with open(path + f'/src/versions{target_versions}.json', 'r') as file:
        return json.load(file)


def _apply_template(template: str, values: 'dict[str,str]') -> str:
    for name, value in values.items():
        print(name, value)
        template = template.replace('{{ ' + name + ' }}', value)
    return template


def _read_manifest(path, platform, versions):
    with open(path + '/src/manifest_template.json', 'r') as file:
        template = file.read()

        values = versions
        values["platform"] = platform

        json_data = _apply_template(template, values)

        return json.loads(json_data)


def _download_artifact(uri) -> io.BytesIO:
    GH_TOKEN = os.environ['GH_TOKEN']

    headers = {'Authorization': f'token {GH_TOKEN}'}
    req = urllib.request.Request(uri, headers=headers)
    with urllib.request.urlopen(req) as response:
        data = response.read()
    assert(data)
    return io.BytesIO(data)


def _download_latest(path, repository: str, fw_platform: str) -> str:
    """
    Download the latest version of an artifact, on the main branch (not from PRs)
    :param repository: The repository, for instance 'crazyflie-firmware'
    :param fw_platform: The firmware platform identifier, for instance 'cf2', 'tag' or 'bolt'. If None, the repo
                        does not have platforms, for instance deck firmware.
    """
    _repo_info, _ = urllib.request.urlretrieve(f'https://api.github.com/repos/bitcraze/{repository}')
    repo_info = json.load(open(_repo_info, 'r'))
    default_branch = repo_info["default_branch"]

    run_url = f'https://api.github.com/repos/bitcraze/{repository}/actions/runs?branch={default_branch};pages=1'
    _run_info, _ = urllib.request.urlretrieve(run_url)
    run_info = json.load(open(_run_info, 'r'))
    artifacts_url = run_info['workflow_runs'][0]['artifacts_url']

    _artifacts, _ = urllib.request.urlretrieve(artifacts_url)
    artifacts = json.load(open(_artifacts, 'r'))

    # Repos with platforms names artifacts: tag-21k1j2h3k1j2h3k1j2h3LongHash
    # Repos without platforms just uses: 9s9asd9as9das9da9sdLongHash

    version = ""
    found_artifact = None
    if fw_platform is not None:
        for artifact in artifacts['artifacts']:
            if artifact["name"].startswith(fw_platform):
                found_artifact = artifact
                version = found_artifact['name'].replace(fw_platform + "-", "")
                break
    else:
        found_artifact = artifacts['artifacts'][0]
        version = found_artifact['name']

    # Download zip
    download_url = found_artifact['archive_download_url']
    print(f"  Downloading artifact from url {download_url}")
    archive = _download_artifact(download_url)

    # Extract firmware from zip
    archive = zipfile.ZipFile(archive)
    firmware_filename = archive.filelist[0].filename
    firmware = archive.read(firmware_filename)
    with open(path + download_dir + "/" + firmware_filename, "wb") as dest:
        dest.write(firmware)

    return version


def _download(path, manifest):
    files_items = list(manifest['files'].items())
    for file_name, file_def in files_items:

        if file_def["release"] == "latest":
            print(f'Downloading latest artifact {file_def["repository"]}, platform: {file_def["platform"]}, ' +
                  f'fw_platform: {manifest["fw_platform"]}')

            fw_platform = manifest['fw_platform']
            if file_def["platform"] == 'deck':
                fw_platform = None

            version = _download_latest(path, file_def['repository'], fw_platform)
            file_def["release"] = version

            new_filename = file_name.replace('-latest', '')
            manifest['files'][new_filename] = manifest['files'].pop(file_name)
        else:
            url = 'https://github.com/bitcraze/' + file_def[
                'repository'] + '/releases/download/' + file_def[
                'release'] + '/' + file_name
            dest = path + download_dir + "/" + file_name

            print(f'Downloading release artifact {file_def["repository"]} {file_def["release"]} to {file_name}')
            urllib.request.urlretrieve(url, dest)

        print(file_name, file_def)


def _create_zip(path, manifest, platform):
    zip_name = \
        path + '/firmware-' + platform + '-' + manifest['release'] + '.zip'
    zf = zipfile.ZipFile(zip_name, mode='w')
    zf.writestr('manifest.json', json.dumps(manifest))
    for file_name in manifest['files']:
        zf.write(path + download_dir + "/" + file_name, arcname=file_name)
    zf.close()
    print("Created " + zip_name)


def _parse_args(argv):
    if len(argv) < 2:
        print("ERROR: Target platform missing")
        exit(-1)

    if len(argv) >= 3:
        target_versions = argv[2]
    else:
        target_versions = ""

    return argv[1], target_versions


def _main(argv):
    root_dir = os.path.dirname(os.path.realpath(__file__)) + "/../.."
    platform, target_versions = _parse_args(argv)
    versions = _read_versions(root_dir, target_versions)
    print("Building release for platform: " + platform)

    manifest = _read_manifest(root_dir, platform, versions)
    _download(root_dir, manifest)
    _create_zip(root_dir, manifest, platform)


if __name__ == '__main__':
    _main(sys.argv)
